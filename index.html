<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Feather Installer by yodaluca23</title>
    <script>
        tailwind.config = {
            darkMode: 'media',
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .loading-dots span {
            display: inline-block;
            width: 6px;
            height: 6px;
            margin: 0 2px;
            background-color: white;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }
    </style>

</head>

<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex items-center justify-center px-4 py-8">
    <div class="bg-white dark:bg-gray-800 shadow-2xl rounded-2xl p-8 w-full max-w-md">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800 dark:text-gray-100">ü™∂ Feather Installer</h1>

        <form id="uploadForm" class="space-y-5">
            <div>
                <label class="block text-sm font-semibold mb-1 text-gray-700 dark:text-gray-300">Certificate
                    Password</label>
                <input type="password" name="password" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1 text-gray-700 dark:text-gray-300">.p12
                    Certificate</label>
                <input type="file" name="p12" accept=".p12" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700" />
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1 text-gray-700 dark:text-gray-300">Mobile Provision
                    (.mobileprovision)</label>
                <input type="file" name="mp" accept=".mobileprovision" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700" />
            </div>

            <button type="submit"
                class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition">
                üîè Sign IPA
            </button>
        </form>

        <div id="response"
            class="mt-6 text-sm font-mono p-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-100 transition-all duration-300">
            üïì Awaiting submission...
        </div>
        <div id="sendToPhoneContainer" class="mt-4 text-center"></div>
    </div>

    <script>
        const responseEl = document.getElementById('response');

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const result = reader.result.split(',')[1]; // Remove data:...base64, prefix
                    resolve(result);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function updateStatus(content, type = 'info') {
            const base = "mt-6 text-sm font-mono p-4 rounded-lg border transition-all duration-300 ";
            const types = {
                info: "bg-blue-50 text-blue-800 border-blue-300 dark:bg-blue-900 dark:text-blue-100 dark:border-blue-700",
                success: "bg-green-50 text-green-800 border-green-300 dark:bg-green-900 dark:text-green-100 dark:border-green-700",
                error: "bg-red-50 text-red-800 border-red-300 dark:bg-red-900 dark:text-red-100 dark:border-red-700",
                warning: "bg-yellow-50 text-yellow-800 border-yellow-300 dark:bg-yellow-900 dark:text-yellow-100 dark:border-yellow-700"
            };
            responseEl.className = base + (types[type] || types.info);
            responseEl.innerHTML = content;
        }

        function createSendToPhoneButton(taskId, importUri) {
            const container = document.getElementById('sendToPhoneContainer');
            container.innerHTML = ''; // Clear previous

            const urlToCopy = `${window.location.origin}${window.location.pathname}?task=${encodeURIComponent(taskId)}&uri=${encodeURIComponent(importUri)}`;

            const button = document.createElement('button');
            button.textContent = 'üì± Send to Phone';
            button.className = 'mt-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition';

            button.onclick = async () => {
                try {
                    await navigator.clipboard.writeText(urlToCopy);
                    showCopiedNotification();
                } catch (err) {
                    alert('Failed to copy URL: ' + err.message);
                }
            };

            container.appendChild(button);
        }

        function showCopiedNotification() {
            const notif = document.createElement('div');
            notif.textContent = '‚úÖ URL copied to clipboard!';
            notif.className = `
        fixed bottom-[-100px] left-1/2 transform -translate-x-1/2 
        bg-purple-600 text-white px-4 py-2 rounded-lg shadow-lg
        transition-all duration-500 ease-in-out z-50
    `;
            document.body.appendChild(notif);

            // Trigger slide in
            requestAnimationFrame(() => {
                notif.classList.remove('bottom-[-100px]');
                notif.classList.add('bottom-6');
            });

            // Slide out after 3s
            setTimeout(() => {
                notif.classList.remove('bottom-6');
                notif.classList.add('bottom-[-100px]');

                // Remove after animation completes
                setTimeout(() => notif.remove(), 500);
            }, 3000);
        }

        async function pollStatus(taskId, importUri, submitBtn = null, paramMode = false) {
            updateStatus(`üõ† Signing in progress...<br><code>Task ID: ${taskId}</code>`, 'info');

            const poll = async () => {
                try {
                    const statusResponse = await fetch(`https://ipa.ipasign.cc/status/${taskId}`);
                    const statusData = await statusResponse.json();

                    if (statusData.status === 'SUCCESS' && statusData.download_url) {
                        const installUrl = `itms-services://?action=download-manifest&url=https://ipa.ipasign.cc/manifest/${statusData.download_url.replace('/download/', '')}.plist`;

                        updateStatus(`
                    ‚úÖ <strong>Signing complete!</strong><br><br>
                    <a href="${installUrl}" target="_blank"
                        class="inline-block mt-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition">
                        üì≤ Install Feather
                    </a>
                    <a href="${importUri}" target="_blank"
                        class="inline-block mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition">
                        üîë Import Certificate
                    </a>
                `, 'success');

                        // Only create "Send to Phone" button if NOT in param mode
                        if (!paramMode) {
                            createSendToPhoneButton(taskId, importUri);
                        }

                        if (submitBtn) submitBtn.disabled = false;
                    } else if (statusData.status === 'FAILED') {
                        updateStatus(`‚ùå Signing failed:<br><code>${statusData.message || 'Unknown error'}</code>`, 'error');
                        if (submitBtn) submitBtn.disabled = false;
                    } else {
                        updateStatus(`‚è≥ Status: ${statusData.status}...<br><code>Task ID: ${taskId}</code>`, 'info');
                        setTimeout(poll, 3000);
                    }
                } catch (err) {
                    updateStatus('üö´ Error: ' + err.message, 'error');
                    if (submitBtn) submitBtn.disabled = false;
                }
            };

            poll();
        }

        // Helper to get query params
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const taskParam = getQueryParam('task');
            const uriParam = getQueryParam('uri');

            if (taskParam && uriParam) {
                // Hide form and start polling automatically
                const form = document.getElementById('uploadForm');
                form.style.display = 'none';

                // pass "true" to indicate param mode so no "Send to Phone" button shows
                pollStatus(taskParam, decodeURIComponent(uriParam), null, true);
            }
        });

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            const password = form.password.value;
            const p12File = form.p12.files[0];
            const mpFile = form.mp.files[0];

            if (!password || !p12File || !mpFile) {
                updateStatus('‚ö†Ô∏è Please fill in all fields.', 'warning');
                return;
            }

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            updateStatus('üîÑ Uploading and signing...', 'info');

            try {
                const ipaResponse = await fetch(`https://cors-anywhere.herokuapp.com/https://github.com/khcrysalis/Feather/releases/latest/download/Feather.ipa`);
                if (!ipaResponse.ok) throw new Error('Failed to download IPA');
                const ipaBlob = await ipaResponse.blob();

                const formData = new FormData();
                formData.append('ipa', ipaBlob, 'Feather.ipa');
                formData.append('p12', p12File);
                formData.append('mp', mpFile);
                formData.append('password', password);

                const uploadResponse = await fetch('https://ipa.ipasign.cc/sign', {
                    method: 'POST',
                    body: formData
                });

                const result = await uploadResponse.json();
                if (!result.task_id) throw new Error('No task_id returned from server');

                const taskId = result.task_id;
                updateStatus(`üõ† Signing in progress...<br><code>Task ID: ${taskId}</code>`, 'info');

                const [p12Base64, mpBase64] = await Promise.all([
                    fileToBase64(p12File),
                    fileToBase64(mpFile),
                ]);
                const passwordBase64 = btoa(unescape(encodeURIComponent(password)));
                const importUrl = `feather://import-certificate?p12=${encodeURIComponent(p12Base64)}&mobileprovision=${encodeURIComponent(mpBase64)}&password=${encodeURIComponent(passwordBase64)}`;

                pollStatus(taskId, importUrl, submitBtn);
            } catch (err) {
                updateStatus('üö´ Error: ' + err.message, 'error');
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
            }
        });
    </script>

    <a href="https://github.com/yodaluca23" target="_blank" rel="noopener noreferrer" class="fixed bottom-4 left-4
          bg-gray-900 dark:bg-gray-100 
          text-white dark:text-gray-900 
          hover:bg-gray-700 dark:hover:bg-gray-300 
          px-4 py-2 rounded-full shadow-lg 
          flex items-center space-x-2 
          z-50">
        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path
                d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.438 9.8 8.205 11.387.6.112.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.726-4.042-1.61-4.042-1.61-.546-1.387-1.333-1.757-1.333-1.757-1.09-.745.083-.73.083-.73 1.205.084 1.84 1.237 1.84 1.237 1.07 1.834 2.807 1.304 3.492.997.108-.776.418-1.305.76-1.605-2.665-.3-5.467-1.335-5.467-5.93 0-1.31.47-2.38 1.236-3.22-.124-.303-.536-1.523.117-3.176 0 0 1.008-.322 3.3 1.23a11.52 11.52 0 013.003-.403c1.02.005 2.045.138 3.003.403 2.29-1.553 3.295-1.23 3.295-1.23.656 1.653.244 2.873.12 3.176.77.84 1.234 1.91 1.234 3.22 0 4.61-2.807 5.625-5.48 5.92.43.37.81 1.1.81 2.22 0 1.606-.015 2.9-.015 3.3 0 .32.21.694.825.576C20.565 21.796 24 17.296 24 12c0-6.63-5.373-12-12-12z" />
        </svg>
        <span>GitHub</span>
    </a>

</body>

</html>
